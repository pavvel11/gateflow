<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Database Setup</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: #e0e0e0; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .btn { background: #00aaff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .result { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 14px; white-space: pre-wrap; }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Quick Database Setup</h1>
        
        <div class="section">
            <h2>1. Check Current Tables</h2>
            <button class="btn" onclick="checkTables()">Check Tables</button>
            <div id="tables-result" class="result">Click to check existing tables</div>
        </div>
        
        <div class="section">
            <h2>2. Setup Products Table</h2>
            <button class="btn" onclick="setupProducts()">Create Products Table</button>
            <div id="products-setup-result" class="result">Click to create products table with sample data</div>
        </div>
        
        <div class="section">
            <h2>3. Setup User Access Table</h2>
            <button class="btn" onclick="setupUserAccess()">Create User Access Table</button>
            <div id="access-setup-result" class="result">Click to create user_product_access table</div>
        </div>
        
        <div class="section">
            <h2>4. Verify Setup</h2>
            <button class="btn" onclick="verifySetup()">Verify All Tables</button>
            <div id="verify-result" class="result">Click to verify everything is working</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <script>
        async function checkTables() {
            const result = document.getElementById('tables-result');
            try {
                // Try to query products table
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('count', { count: 'exact', head: true });
                
                // Try to query user_product_access table
                const { data: access, error: accessError } = await supabase
                    .from('user_product_access')
                    .select('count', { count: 'exact', head: true });
                
                let status = '';
                
                if (productsError) {
                    status += `Products table: <span class="error">NOT FOUND (${productsError.message})</span>\n`;
                } else {
                    status += `Products table: <span class="success">EXISTS (${products || 0} records)</span>\n`;
                }
                
                if (accessError) {
                    status += `User access table: <span class="error">NOT FOUND (${accessError.message})</span>\n`;
                } else {
                    status += `User access table: <span class="success">EXISTS (${access || 0} records)</span>\n`;
                }
                
                result.innerHTML = status;
            } catch (e) {
                result.innerHTML = `<span class="error">Exception: ${e.message}</span>`;
            }
        }
        
        async function setupProducts() {
            const result = document.getElementById('products-setup-result');
            try {
                result.innerHTML = 'Creating products table...';
                
                // Note: This won't work from client side due to RLS
                // We need to use the Supabase dashboard or API
                result.innerHTML = `<span class="warning">‚ö†Ô∏è Table creation must be done in Supabase Dashboard</span>

Go to your Supabase Dashboard:
1. Open SQL Editor
2. Run the setup script from gateflow_setup.sql

Or create manually:
- Table name: products
- Columns: id, name, slug, description, icon, price, theme, layout_template, stripe_price_id
- Sample data: slug='awesome-free-product', price=0`;
                
            } catch (e) {
                result.innerHTML = `<span class="error">Exception: ${e.message}</span>`;
            }
        }
        
        async function setupUserAccess() {
            const result = document.getElementById('access-setup-result');
            try {
                result.innerHTML = `<span class="warning">‚ö†Ô∏è Table creation must be done in Supabase Dashboard</span>

Go to your Supabase Dashboard:
1. Open SQL Editor  
2. Run the setup script from user_product_access_setup.sql

Or create manually:
- Table name: user_product_access
- Columns: id, user_id, product_slug, created_at
- RLS enabled with appropriate policies`;
                
            } catch (e) {
                result.innerHTML = `<span class="error">Exception: ${e.message}</span>`;
            }
        }
        
        async function verifySetup() {
            const result = document.getElementById('verify-result');
            try {
                // Check products
                const { data: products, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .eq('slug', 'awesome-free-product');
                
                let status = '';
                
                if (productsError) {
                    status += `<span class="error">‚ùå Products table error: ${productsError.message}</span>\n`;
                } else if (!products || products.length === 0) {
                    status += `<span class="error">‚ùå Product 'awesome-free-product' not found</span>\n`;
                } else {
                    const product = products[0];
                    status += `<span class="success">‚úÖ Product found: ${product.name} (price: ${product.price})</span>\n`;
                }
                
                // Check user access table structure
                const { data: access, error: accessError } = await supabase
                    .from('user_product_access')
                    .select('*')
                    .limit(1);
                
                if (accessError) {
                    status += `<span class="error">‚ùå User access table error: ${accessError.message}</span>\n`;
                } else {
                    status += `<span class="success">‚úÖ User access table accessible</span>\n`;
                }
                
                // Check current session
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    status += `<span class="success">‚úÖ User logged in: ${session.user.email}</span>\n`;
                } else {
                    status += `<span class="warning">‚ö†Ô∏è No user logged in</span>\n`;
                }
                
                result.innerHTML = status;
                
            } catch (e) {
                result.innerHTML = `<span class="error">Exception: ${e.message}</span>`;
            }
        }
    </script>
</body>
</html>
